# 因子开发标准

## Guide

### 开发流程概览
1. 环境激活
2. 编写因子
3. 测试验证
4. 相关性分析
5. 更新factors.yaml
6. 格式验证


以上过程需要作为todos逐一确认

# 1. 环境要求

1. 必须在qlib conda环境下运行
   ```bash
   # 激活qlib环境
   conda activate qlib

   # 验证环境
   python -c "import qlib; print(qlib.__version__)"
   ```
2. 必须要`factors`文件夹下

# 2. 编写因子

因子可以通过以下三种方式之一进行开发：

## 2.1 使用Qlib表达式

1. 因子公式必须使用qlib的语法规范
   - 使用qlib提供的运算符和函数
   - 遵循qlib的表达式规则
   - 参考qlib官方文档中的因子示例
   - OHLCV字段必须使用以下格式：
     ```python
     $open   # 开盘价
     $high   # 最高价
     $low    # 最低价
     $close  # 收盘价
     $volume # 成交量
     ```

2. 示例代码

    ```python
    from factor_inspector import calculate_and_validate_factors

    # 因子定义
    expressions = {
        "VOL5": {
            "type": "qlib_expression",
            "expression": "Mean($volume, 5)"
        }
    }

    if __name__ == "__main__":
        calculate_and_validate_factors(expressions)
    ```

## 2.2 使用Talib函数

1. 使用talib提供的技术分析函数
   - 直接使用talib函数名
   - 指定输入数据字段
   - 配置函数参数

2. 示例代码

    ```python
    from factor_inspector import calculate_and_validate_factors

    # 因子定义
    expressions = {
        "ADX14": {
            "type": "talib_function",
            "function": "ADX",
            "inputs": ["$high", "$low", "$close"],
            "params": {"timeperiod": 14}
        }
    }

    if __name__ == "__main__":
        calculate_and_validate_factors(expressions)
    ```

## 2.3 使用Python代码

1. 使用自定义Python代码
   - 可以使用pandas和numpy等库
   - 可以调用talib函数
   - 需要指定输入和输出变量

2. 示例代码

    ```python
    from factor_inspector import calculate_and_validate_factors

    # 因子定义
    expressions = {
        "CustomMA": {
            "type": "python_code",
            "code": """
result = pd.Series(talib.MA(close, timeperiod=10), index=data.index)
""",
            "inputs": ["close"],
            "outputs": ["result"]
        }
    }

    if __name__ == "__main__":
        calculate_and_validate_factors(expressions)
    ```

3. 因子测试规范
   - 测试文件位置：factors/目录下
   - 测试文件命名：factor_dev_[因子名称].py
   - 示例：
     ```
     factors/
     ├── factor_dev_VOL5.py
     ├── factor_dev_MACD.py
     └── factor_dev_RSI.py
     ```

# 3. 测试验证 & 相关性分析
```
python factor_dev_....py
```
因为调用`calculate_and_validate_factors`函数，最终会输出因子相关性列表，因子相关性从高到低排列，结果示例
```
分析因子: RSI
--------------------------------------------------
【重点】QTLD20: 相关性=-0.889
【重点】RSV20: 相关性=0.865
【重点】MA20: 相关性=-0.856
【重点】QTLD30: 相关性=-0.827
【重点】RANK20: 相关性=0.822
【重点】SUMN10: 相关性=-0.814
【重点】SUMP10: 相关性=0.814
【重点】SUMD10: 相关性=0.814
【重点】MA30: 相关性=-0.812
【重点】RSV30: 相关性=0.808
```
如果与所有因子相关性都显示未nan，则因子开发存在问题，需要分析并重新开发

# 5. 更新factors.yaml

### 自定义因子必填字段
1. **name**: 因子名称（英文）
2. **qlib_expression**: qlib表达式
3. **source**: `"custom_factor"`（自定义因子固定值）
4. **description**: 因子描述（中文）
5. **formula**: 通用数学公式（中文）
6. **tags**: 分类标签数组
7. **metadata**: 数据依赖数组

### 标准分类体系
- 量价类、动量类、趋势类、波动率类、技术指标类、量价关系类、反转类

## 因子字段规范

每个因子必须包含以下标准字段结构，确保因子库的统一性和可维护性：

### 必填字段

1. **name**: 因子名称
   - 格式：字符串，简洁明了的英文名称
   - 命名规范：大写字母，比如OBV，如果使用特定周期则增加数字数字，如 "RSI_14", "MA_5", "BETA_60"
   - 示例：`"RSI_14"`

2. **计算方式**（以下三种方式选择一种）:

   a) **qlib_expression**: qlib表达式
      - 使用qlib的表达式语法
      - 示例：`"Mean($volume, 5)"`

   b) **talib_function**: talib函数
      - 函数名称：talib提供的函数名
      - inputs：输入数据字段列表
      - params：函数参数字典
      - 示例：
        ```yaml
        talib_function: ADX
        inputs: ["$high", "$low", "$close"]
        params:
          timeperiod: 14
        ```

   c) **python_code**: Python代码
      - code：Python代码字符串
      - inputs：输入数据字段列表
      - outputs：输出变量名列表
      - 示例：
        ```yaml
        python_code: |
          result = pd.Series(talib.MA(close, timeperiod=10), index=data.index)
        inputs: ["close"]
        outputs: ["result"]
        ```

3. **source**: 数据源标识
   - **自定义因子必须使用**: `"custom_factor"`
   - Alpha158因子使用: `"Alpha158"`
   - 其他来源因子使用相应标识

4. **description**: 因子描述
   - 格式：中文字符串，详细说明因子的含义和用途
   - 应包含：因子的数学含义、应用场景、预期效果
   - 示例：`"14日相对强弱指数，用于衡量价格动量强弱"`

5. **formula**: 通用数学公式
   - 格式：中文字符串，人类可理解的数学公式表达
   - 使用通用数学符号而非qlib特定语法
   - 示例：`"100 - 100 / (1 + 14日平均上涨量 / 14日平均下跌量)"`

6. **tags**: 分类标签
   - 格式：字符串数组，用于因子分类和筛选
   - 主要分类包括：
     - `"量价类"`: 基础价格和成交量关系
     - `"动量类"`: 价格动量和趋势
     - `"趋势类"`: 移动平均和趋势分析
     - `"波动率类"`: 价格波动性衡量
     - `"技术指标类"`: 经典技术分析指标
     - `"量价关系类"`: 价格与成交量相关性
     - `"反转类"`: 均值回归信号
   - 示例：`["技术指标类", "动量指标"]`

7. **metadata**: 数据依赖
   - 格式：字符串数组，列出因子计算所需的基础数据
   - 包含的数据字段：`"$open"`, `"$high"`, `"$low"`, `"$close"`, `"$volume"`, `"$vwap"`
   - 示例：`["$close", "$volume"]`

## 因子相似性检索

在提出新的理论或公式时，可以使用因子相似性检索功能来避免重复开发：

### 使用--search-similar进行检索

```bash
# 激活qlib环境
conda activate qlib

# 切换到factors目录
cd factors/

# 使用因子相似性检索
python factor_inspector.py --search-similar "你的因子描述或公式"
```

### 检索示例

```bash
# 检索动量相关因子
python factor_inspector.py --search-similar "价格动量指标"

# 检索技术指标
python factor_inspector.py --search-similar "RSI相对强弱指数"

# 检索成交量相关因子
python factor_inspector.py --search-similar "成交量均值"
```

### 检索结果解读

检索结果会显示：
- 相似因子的名称和描述
- 相似度评分
- 现有因子的qlib表达式
- 分类标签信息

如果发现高度相似的因子，建议：
1. 直接使用现有因子
2. 对现有因子进行参数调整
3. 开发互补性因子而非重复因子

## 开发流程

1. 激活qlib环境
2. **进行因子相似性检索**（可选但推荐）
   ```bash
   # 在提出新理论或公式前，先检索相似因子
   python factor_inspector.py --search-similar "你的因子描述或公式"
   ```
3. 创建新因子文件（使用上述模板）
4. 编写因子公式（使用qlib语法）
5. 添加完整的注释文档（包含所有字段信息）
6. 运行因子文件进行自动计算和验证
7. 将因子添加到factors.yaml文件中
8. 验证yaml文件格式和字段完整性
9. 根据相关性分析结果优化因子

## 因子库更新流程

完成因子开发后，需要将因子添加到现有因子库中，确保因子库的完整性和一致性：

### 2.1 将因子相关信息增量添加到factors.yaml

1. **打开factors.yaml文件**
   ```bash
   # 在factors目录下
   cd factors/
   # 使用文本编辑器打开
   code factors.yaml  # 或使用其他编辑器
   ```

2. **添加新因子条目**
   按照标准格式添加新因子，确保包含所有7个必填字段：
   ```yaml
   - name: YOUR_FACTOR_NAME
     qlib_expression: YOUR_QLIB_EXPRESSION
     source: custom_factor
     description: 详细的中文描述
     formula: 通用数学公式
     tags: ["分类标签1", "分类标签2"]
     metadata: ["$close", "$volume"]
   ```

3. **验证YAML格式**
   ```bash
   # 验证YAML文件格式正确性
   python -c "import yaml; yaml.safe_load(open('factors.yaml', 'r', encoding='utf-8')); print('YAML文件格式验证成功！')"
   ```

4. **检查字段完整性**
   - 确保所有7个必填字段都已填写
   - 验证source字段为"custom_factor"
   - 检查tags使用标准分类体系
   - 确认metadata包含所有使用的数据字段

### 2.2 在factors_embeddings.yaml中添加新因子的embedding

1. **生成新因子的embedding**
   ```bash
   # 运行embedding生成命令
   python factor_inspector.py --generate-embeddings
   ```

2. **验证embedding文件**
   ```bash
   # 检查factors_embeddings.yaml文件
   python -c "import yaml; embeddings = yaml.safe_load(open('factors_embeddings.yaml', 'r', encoding='utf-8')); print(f'当前包含 {len(embeddings)} 个因子的embedding')"
   ```

3. **增量更新说明**
   - 新因子的embedding会自动添加到factors_embeddings.yaml
   - 现有因子的embedding不会被重新生成
   - 系统会保持embedding的一致性

### 更新后的验证步骤

1. **运行因子测试**
   ```bash
   # 测试新添加的因子
   python factor_inspector.py --test-factor YOUR_FACTOR_NAME
   ```

2. **检查相关性**
   ```bash
   # 分析新因子与现有因子的相关性
   python factor_inspector.py --corr cache/factor.csv
   ```

3. **验证因子库完整性**
   ```bash
   # 检查factors.yaml和factors_embeddings.yaml的一致性
   python factor_inspector.py --validate-library
   ```

### 注意事项

1. **增量更新原则**
   - 只添加新因子，不修改现有因子
   - 保持现有因子的稳定性和兼容性
   - 确保新因子不会破坏现有因子库的结构

2. **版本控制**
   - 在添加新因子前创建备份
   - 使用git等版本控制工具跟踪变更
   - 记录因子添加的时间和原因

3. **文档同步**
   - 更新相关的文档说明
   - 记录新因子的使用方法和注意事项
   - 更新因子库的总体说明

4. **测试验证**
   - 确保新因子能正常计算
   - 验证与现有因子的兼容性
   - 检查性能影响

## 注意事项

1. 确保在正确的conda环境(qlib)下运行所有命令
2. 确保handler_config.yaml中包含正确的配置参数
3. 验证因子时注意观察与现有因子库的相关性
4. 保持因子命名的规范性和可读性
5. 定期更新和维护因子文档
6. OHLCV字段必须加上$前缀，否则会出现"name not defined"错误
7. **自定义因子的source字段必须使用"custom_factor"**
8. 所有因子必须在factors.yaml中包含完整的7个字段
9. 分类标签必须使用标准分类体系
10. 数据依赖字段必须准确列出所有使用的数据


## factors.yaml添加示例

开发完成的因子需要按以下格式添加到factors.yaml文件中。以下是不同类型因子的示例：

### 1. Qlib表达式因子

```yaml
- name: VOL5
  qlib_expression: Mean($volume, 5)
  source: custom_factor
  description: 5日成交量均值，用于衡量交易活跃度
  formula: 5日成交量均价
  tags: ["量价类", "成交量指标"]
  metadata: ["$volume"]
```

### 2. Talib函数因子

```yaml
- name: ADX14
  talib_function: ADX
  inputs: ["$high", "$low", "$close"]
  params:
    timeperiod: 14
  source: custom_factor
  description: Average Directional Index (ADX)指标，用于衡量趋势的强度，不论趋势是向上还是向下
  formula: ADX = 100 * SMA(abs(+DI - -DI) / (+DI + -DI), 14)，其中DI是方向指标
  tags: ["趋势类", "动量指标"]
  metadata: ["$high", "$low", "$close"]
```

### 3. Python代码因子

```yaml
- name: CustomMA10
  python_code: |
    result = pd.Series(talib.MA(close, timeperiod=10), index=data.index)
  inputs: ["close"]
  outputs: ["result"]
  source: custom_factor
  description: 使用talib库计算的10日移动平均线
  formula: 10日价格简单移动平均
  tags: ["趋势类", "移动平均"]
  metadata: ["$close"]
```

## 运行示例

```bash
# 激活环境
conda activate qlib

# 运行因子测试
cd factors/
python factor_test_VOL5.py

# 验证factors.yaml文件格式
python -c "import yaml; yaml.safe_load(open('factors.yaml', 'r', encoding='utf-8')); print('YAML文件格式验证成功！')"

# 检查因子相关性（可选）
python factor_inspector.py --corr cache/factor.csv
```

## Qlib运算符使用指南

Qlib提供了丰富的运算符用于因子开发。以下是主要运算符的分类和使用示例：

### 1. 基础运算符

#### 元素级运算符
```python
# 绝对值
Abs($close - $open)  # 计算收盘价与开盘价的差值的绝对值

# 对数
Log($close)  # 计算收盘价的自然对数

# 符号函数
Sign($close - $open)  # 收盘价大于开盘价返回1，小于返回-1，等于返回0
```

#### 算术运算符
```python
# 基本运算
Add($close, $open)  # 等同于 ($close + $open)
Sub($high, $low)    # 等同于 ($high - $low)
Mul($close, $volume)  # 等同于 ($close * $volume)
Div($volume, 10000)   # 等同于 ($volume / 10000)

# 幂运算
Power($close, 2)  # 收盘价的平方
```

### 2. 统计运算符

#### 滚动窗口计算
```python
# 移动平均
Mean($close, 5)  # 5日移动平均
EMA($close, 12)   # 12日指数移动平均
WMA($close, 10)   # 10日加权移动平均

# 波动率相关
Std($close, 20)   # 20日标准差
Var($close, 20)   # 20日方差
Mad($close, 20)   # 20日平均绝对偏差

# 统计分布特征
Skew($close, 30)  # 30日偏度
Kurt($close, 30)  # 30日峰度
```

#### 截面统计
```python
# 排名和分位数
Rank($close, 10)     # 10日滚动排名
Quantile($close, 10, 0.75)  # 10日75%分位数

# 极值
Max($high, 5)     # 5日最高价
Min($low, 5)      # 5日最低价
IdxMax($close, 5)  # 5日内最高收盘价的位置
IdxMin($close, 5)  # 5日内最低收盘价的位置
```

### 3. 时序运算符

```python
# 引用历史数据
Ref($close, 1)    # 前一日收盘价
Delta($close, 1)  # 与前一日收盘价的差值

# 趋势分析
Slope($close, 10)   # 10日价格趋势斜率
Rsquare($close, 10) # 10日价格趋势R方值
Resi($close, 10)    # 10日价格趋势残差
```

### 4. 条件运算符

```python
# 逻辑运算
And(Greater($close, $open), Greater($volume, Mean($volume, 5)))  # 收盘价大于开盘价且成交量大于5日均量

# 条件判断
If(Greater($close, $open),
   $volume,
   0)  # 如果收盘价大于开盘价返回成交量，否则返回0
```

### 5. 相关性运算符

```python
# 相关系数和协方差
Corr($close, $volume, 20)  # 20日收盘价和成交量的相关系数
Cov($close, $volume, 20)   # 20日收盘价和成交量的协方差
```

### 6. 复杂因子示例

```python
# MACD示例
def MACD(series, fast=12, slow=26, signal=9):
    fast_ma = EMA(series, fast)
    slow_ma = EMA(series, slow)
    diff = Sub(fast_ma, slow_ma)
    dea = EMA(diff, signal)
    macd = Sub(diff, dea)
    return macd

# RSI示例
def RSI(series, window=14):
    diff = Sub(series, Ref(series, 1))
    positive = If(Greater(diff, 0), diff, 0)
    negative = If(Less(diff, 0), Abs(diff), 0)
    rsi = Mul(Div(Mean(positive, window),
                  Add(Mean(positive, window), Mean(negative, window))),
              100)
    return rsi

# 布林带示例
def BOLL(series, window=20, k=2):
    ma = Mean(series, window)
    std = Std(series, window)
    upper = Add(ma, Mul(std, k))
    lower = Sub(ma, Mul(std, k))
    return upper, ma, lower
```

### 7. 最佳实践

1. 运算符嵌套
   - 可以通过嵌套运算符构建复杂因子
   - 注意控制嵌套层数，过深的嵌套可能影响性能

2. 性能优化
   - 优先使用内置运算符而不是自定义函数
   - 避免重复计算相同的中间结果
   - 对于常用的中间结果可以保存为临时变量

3. 代码可读性
   - 为复杂表达式添加清晰的注释
   - 使用有意义的变量名
   - 将复杂逻辑拆分为多个步骤

4. 数据预处理
   - 注意处理异常值和缺失值
   - 考虑数据的时效性和更新频率
   - 注意数据的单位和规模
