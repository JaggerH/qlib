# 因子开发标准

## 环境要求

1. 必须在qlib conda环境下运行
   ```bash
   # 激活qlib环境
   conda activate qlib

   # 验证环境
   python -c "import qlib; print(qlib.__version__)"
   ```

## 基本要求

1. 因子公式必须使用qlib的语法规范
   - 使用qlib提供的运算符和函数
   - 遵循qlib的表达式规则
   - 参考qlib官方文档中的因子示例
   - OHLCV字段必须使用以下格式：
     ```python
     $open   # 开盘价
     $high   # 最高价
     $low    # 最低价
     $close  # 收盘价
     $volume # 成交量
     ```

2. 配置文件和参数读取
   ```python
   from factor_inspector import read_corr_params

   # 从配置文件读取相关性分析参数
   instruments, start_time, end_time = read_corr_params("handler_config.yaml")
   ```

3. 因子结果存储规范
   ```python
   # 初始化qlib
   qlib.init(region=REG_CN)

   # 获取因子数据
   df = D.features(instruments, list(factors.values()), start_time, end_time)
   df.columns = factors.keys()

   # 保存到指定路径
   df.to_csv("cache/factor.csv")
   ```

4. 代码注释规范
   ```python
   """
   因子名称：[factor_name]
   因子描述：[detailed_description]
   计算公式：[qlib_formula]

   示例：
   因子名称：VOL5
   因子描述：5日成交量均值
   计算公式：Mean($volume, 5)
   """
   ```

5. 因子验证流程
   ```bash
   # 使用factor_inspector验证因子相关性
   python factor_inspector.py --corr cache/factor.csv
   ```

6. 因子测试规范
   - 测试文件位置：factors/目录下
   - 测试文件命名：factor_test_[因子名称].py
   - 示例：
     ```
     factors/
     ├── factor_test_VOL5.py
     ├── factor_test_MACD.py
     └── factor_test_RSI.py
     ```

## 开发流程

1. 激活qlib环境
2. 创建新因子文件
3. 编写因子公式（使用qlib语法）
4. 添加完整的注释文档
5. 创建对应的测试文件
6. 运行因子计算并保存结果
7. 使用factor_inspector验证因子效果
8. 根据相关性分析结果优化因子

## 注意事项

1. 确保在正确的conda环境(qlib)下运行所有命令
2. 确保handler_config.yaml中包含正确的配置参数
3. 验证因子时注意观察与现有因子库的相关性
4. 保持因子命名的规范性和可读性
5. 定期更新和维护因子文档
6. 每个因子必须有对应的测试文件
7. OHLCV字段必须加上$前缀，否则会出现"name not defined"错误

## 示例代码

```python
# 确保在qlib环境下运行
from qlib.data import D
import qlib
from qlib.config import REG_CN

# 因子定义
factors = {
    "VOL5": "Mean($volume, 5)",  # 5日成交量均值
    "MACD": "(Mean($close, 12) - Mean($close, 26))",  # MACD指标
    "HL_PCT": "($high - $low) / $low * 100"  # 振幅百分比
}

# 读取配置
instruments, start_time, end_time = read_corr_params("handler_config.yaml")

# 初始化并计算
qlib.init(region=REG_CN)
df = D.features(instruments, list(factors.values()), start_time, end_time)
df.columns = factors.keys()
df.to_csv("cache/factor.csv")
```

## 运行示例

```bash
# 激活环境
conda activate qlib

# 运行因子测试
cd factors/
python factor_test_VOL5.py

# 验证因子相关性
python factor_inspector.py --corr cache/factor.csv
```
