# 因子开发标准

## 快速参考

### 自定义因子必填字段
1. **name**: 因子名称（英文）
2. **qlib_expression**: qlib表达式
3. **source**: `"custom_factor"`（自定义因子固定值）
4. **description**: 因子描述（中文）
5. **formula**: 通用数学公式（中文）
6. **tags**: 分类标签数组
7. **metadata**: 数据依赖数组

### 标准分类体系
- 量价类、动量类、趋势类、波动率类、技术指标类、量价关系类、反转类

### 开发流程概览
环境激活 → 编写因子 → 测试验证 → 更新factors.yaml → 格式验证 → 相关性分析

---

## 环境要求

1. 必须在qlib conda环境下运行
   ```bash
   # 激活qlib环境
   conda activate qlib

   # 验证环境
   python -c "import qlib; print(qlib.__version__)"
   ```

## 基本要求

1. 因子公式必须使用qlib的语法规范
   - 使用qlib提供的运算符和函数
   - 遵循qlib的表达式规则
   - 参考qlib官方文档中的因子示例
   - OHLCV字段必须使用以下格式：
     ```python
     $open   # 开盘价
     $high   # 最高价
     $low    # 最低价
     $close  # 收盘价
     $volume # 成交量
     ```

## 因子字段规范

每个因子必须包含以下标准字段结构，确保因子库的统一性和可维护性：

### 必填字段

1. **name**: 因子名称
   - 格式：字符串，简洁明了的英文名称
   - 命名规范：大写字母+数字，如 "RSI_14", "MA_5", "BETA_60"
   - 示例：`"RSI_14"`

2. **qlib_expression**: qlib表达式
   - 格式：字符串，符合qlib语法的因子计算公式
   - 必须包含所需的数据字段（$open, $close等）
   - 示例：`"100 - 100 / (1 + $avg_gain / $avg_loss)"`

3. **source**: 数据源标识
   - **自定义因子必须使用**: `"custom_factor"`
   - Alpha158因子使用: `"Alpha158"`
   - 其他来源因子使用相应标识

4. **description**: 因子描述
   - 格式：中文字符串，详细说明因子的含义和用途
   - 应包含：因子的数学含义、应用场景、预期效果
   - 示例：`"14日相对强弱指数，用于衡量价格动量强弱"`

5. **formula**: 通用数学公式
   - 格式：中文字符串，人类可理解的数学公式表达
   - 使用通用数学符号而非qlib特定语法
   - 示例：`"100 - 100 / (1 + 14日平均上涨量 / 14日平均下跌量)"`

6. **tags**: 分类标签
   - 格式：字符串数组，用于因子分类和筛选
   - 主要分类包括：
     - `"量价类"`: 基础价格和成交量关系
     - `"动量类"`: 价格动量和趋势
     - `"趋势类"`: 移动平均和趋势分析
     - `"波动率类"`: 价格波动性衡量
     - `"技术指标类"`: 经典技术分析指标
     - `"量价关系类"`: 价格与成交量相关性
     - `"反转类"`: 均值回归信号
   - 示例：`["技术指标类", "动量指标"]`

7. **metadata**: 数据依赖
   - 格式：字符串数组，列出因子计算所需的基础数据
   - 包含的数据字段：`"$open"`, `"$high"`, `"$low"`, `"$close"`, `"$volume"`, `"$vwap"`
   - 示例：`["$close", "$volume"]`

### 因子定义示例

```yaml
- name: RSI_14
  qlib_expression: 100 - 100 / (1 + $avg_gain / $avg_loss)
  source: custom_factor
  description: 14日相对强弱指数，用于衡量价格动量强弱，识别超买超卖状态
  formula: 100 - 100 / (1 + 14日平均上涨量 / 14日平均下跌量)
  tags: ["技术指标类", "动量指标"]
  metadata: ["$avg_gain", "$avg_loss"]

- name: MA_5
  qlib_expression: Mean($close, 5)/$close
  source: custom_factor
  description: 5日移动平均价相对当前收盘价的比率，用于判断短期趋势
  formula: 5日均价 / 当前收盘价
  tags: ["趋势类", "移动平均"]
  metadata: ["$close"]
```

2. 因子开发模板
   ```python
   from factor_inspector import calculate_and_validate_factors

   # 因子定义
   expressions = {
       "FACTOR_NAME": "FACTOR_EXPRESSION",  # 因子表达式
   }

   """
   因子名称：[factor_name]
   因子描述：[detailed_description]
   计算公式：[qlib_formula]
   分类标签：[tags]
   数据依赖：[metadata]

   示例：
   因子名称：VOL5
   因子描述：5日成交量均值，用于衡量交易活跃度
   计算公式：Mean($volume, 5)
   分类标签：["量价类", "成交量指标"]
   数据依赖：["$volume"]
   """

   if __name__ == "__main__":
       calculate_and_validate_factors(expressions)
   ```

3. 代码注释规范
   - 每个因子必须包含完整的文档字符串
   - 文档字符串必须包含：因子名称、描述、计算公式、分类标签、数据依赖
   - 对于复杂因子，应该添加额外的参数说明和使用示例
   - 注释格式必须遵循因子字段规范

4. 因子测试规范
   - 测试文件位置：factors/目录下
   - 测试文件命名：factor_test_[因子名称].py
   - 示例：
     ```
     factors/
     ├── factor_test_VOL5.py
     ├── factor_test_MACD.py
     └── factor_test_RSI.py
     ```

5. factors.yaml更新规范
   - 开发完成的因子必须添加到factors.yaml文件中
   - 必须包含所有7个必填字段
   - source字段统一使用"custom_factor"
   - 验证yaml文件格式正确性

## 开发流程

1. 激活qlib环境
2. 创建新因子文件（使用上述模板）
3. 编写因子公式（使用qlib语法）
4. 添加完整的注释文档（包含所有字段信息）
5. 运行因子文件进行自动计算和验证
6. 将因子添加到factors.yaml文件中
7. 验证yaml文件格式和字段完整性
8. 根据相关性分析结果优化因子

## 注意事项

1. 确保在正确的conda环境(qlib)下运行所有命令
2. 确保handler_config.yaml中包含正确的配置参数
3. 验证因子时注意观察与现有因子库的相关性
4. 保持因子命名的规范性和可读性
5. 定期更新和维护因子文档
6. OHLCV字段必须加上$前缀，否则会出现"name not defined"错误
7. **自定义因子的source字段必须使用"custom_factor"**
8. 所有因子必须在factors.yaml中包含完整的7个字段
9. 分类标签必须使用标准分类体系
10. 数据依赖字段必须准确列出所有使用的数据

## 示例代码

```python
# factor_test_VOL5.py
from factor_inspector import calculate_and_validate_factors

# 因子定义
expressions = {
    "VOL5": "Mean($volume, 5)",  # 5日成交量均值
    "VOL5_STD": "Std($volume, 5)",  # 5日成交量标准差
}

"""
因子名称：VOL5
因子描述：5日成交量均值，用于衡量交易活跃度
计算公式：Mean($volume, 5)
分类标签：["量价类", "成交量指标"]
数据依赖：["$volume"]

因子名称：VOL5_STD
因子描述：5日成交量标准差，用于衡量交易量波动性
计算公式：Std($volume, 5)
分类标签：["波动率类", "成交量指标"]
数据依赖：["$volume"]
"""

if __name__ == "__main__":
    calculate_and_validate_factors(expressions)
```

## factors.yaml添加示例

开发完成的因子需要按以下格式添加到factors.yaml文件中：

```yaml
- name: VOL5
  qlib_expression: Mean($volume, 5)
  source: custom_factor
  description: 5日成交量均值，用于衡量交易活跃度
  formula: 5日成交量均价
  tags: ["量价类", "成交量指标"]
  metadata: ["$volume"]

- name: VOL5_STD
  qlib_expression: Std($volume, 5)
  source: custom_factor
  description: 5日成交量标准差，用于衡量交易量波动性
  formula: 5日成交量标准差
  tags: ["波动率类", "成交量指标"]
  metadata: ["$volume"]
```

## 运行示例

```bash
# 激活环境
conda activate qlib

# 运行因子测试
cd factors/
python factor_test_VOL5.py

# 验证factors.yaml文件格式
python -c "import yaml; yaml.safe_load(open('factors.yaml', 'r', encoding='utf-8')); print('YAML文件格式验证成功！')"

# 检查因子相关性（可选）
python factor_inspector.py --corr cache/factor.csv
```

## Qlib运算符使用指南

Qlib提供了丰富的运算符用于因子开发。以下是主要运算符的分类和使用示例：

### 1. 基础运算符

#### 元素级运算符
```python
# 绝对值
Abs($close - $open)  # 计算收盘价与开盘价的差值的绝对值

# 对数
Log($close)  # 计算收盘价的自然对数

# 符号函数
Sign($close - $open)  # 收盘价大于开盘价返回1，小于返回-1，等于返回0
```

#### 算术运算符
```python
# 基本运算
Add($close, $open)  # 等同于 ($close + $open)
Sub($high, $low)    # 等同于 ($high - $low)
Mul($close, $volume)  # 等同于 ($close * $volume)
Div($volume, 10000)   # 等同于 ($volume / 10000)

# 幂运算
Power($close, 2)  # 收盘价的平方
```

### 2. 统计运算符

#### 滚动窗口计算
```python
# 移动平均
Mean($close, 5)  # 5日移动平均
EMA($close, 12)   # 12日指数移动平均
WMA($close, 10)   # 10日加权移动平均

# 波动率相关
Std($close, 20)   # 20日标准差
Var($close, 20)   # 20日方差
Mad($close, 20)   # 20日平均绝对偏差

# 统计分布特征
Skew($close, 30)  # 30日偏度
Kurt($close, 30)  # 30日峰度
```

#### 截面统计
```python
# 排名和分位数
Rank($close, 10)     # 10日滚动排名
Quantile($close, 10, 0.75)  # 10日75%分位数

# 极值
Max($high, 5)     # 5日最高价
Min($low, 5)      # 5日最低价
IdxMax($close, 5)  # 5日内最高收盘价的位置
IdxMin($close, 5)  # 5日内最低收盘价的位置
```

### 3. 时序运算符

```python
# 引用历史数据
Ref($close, 1)    # 前一日收盘价
Delta($close, 1)  # 与前一日收盘价的差值

# 趋势分析
Slope($close, 10)   # 10日价格趋势斜率
Rsquare($close, 10) # 10日价格趋势R方值
Resi($close, 10)    # 10日价格趋势残差
```

### 4. 条件运算符

```python
# 逻辑运算
And(Greater($close, $open), Greater($volume, Mean($volume, 5)))  # 收盘价大于开盘价且成交量大于5日均量

# 条件判断
If(Greater($close, $open),
   $volume,
   0)  # 如果收盘价大于开盘价返回成交量，否则返回0
```

### 5. 相关性运算符

```python
# 相关系数和协方差
Corr($close, $volume, 20)  # 20日收盘价和成交量的相关系数
Cov($close, $volume, 20)   # 20日收盘价和成交量的协方差
```

### 6. 复杂因子示例

```python
# MACD示例
def MACD(series, fast=12, slow=26, signal=9):
    fast_ma = EMA(series, fast)
    slow_ma = EMA(series, slow)
    diff = Sub(fast_ma, slow_ma)
    dea = EMA(diff, signal)
    macd = Sub(diff, dea)
    return macd

# RSI示例
def RSI(series, window=14):
    diff = Sub(series, Ref(series, 1))
    positive = If(Greater(diff, 0), diff, 0)
    negative = If(Less(diff, 0), Abs(diff), 0)
    rsi = Mul(Div(Mean(positive, window),
                  Add(Mean(positive, window), Mean(negative, window))),
              100)
    return rsi

# 布林带示例
def BOLL(series, window=20, k=2):
    ma = Mean(series, window)
    std = Std(series, window)
    upper = Add(ma, Mul(std, k))
    lower = Sub(ma, Mul(std, k))
    return upper, ma, lower
```

### 7. 最佳实践

1. 运算符嵌套
   - 可以通过嵌套运算符构建复杂因子
   - 注意控制嵌套层数，过深的嵌套可能影响性能

2. 性能优化
   - 优先使用内置运算符而不是自定义函数
   - 避免重复计算相同的中间结果
   - 对于常用的中间结果可以保存为临时变量

3. 代码可读性
   - 为复杂表达式添加清晰的注释
   - 使用有意义的变量名
   - 将复杂逻辑拆分为多个步骤

4. 数据预处理
   - 注意处理异常值和缺失值
   - 考虑数据的时效性和更新频率
   - 注意数据的单位和规模
