# 因子库的构建
## 基本面因子
- **估值因子**
  - 市盈率（PE, Price/Earnings）：`PE = 总市值 / 净利润`
  - 市净率（PB, Price/Book）：`PB = 总市值 / 净资产`
  - 市销率（PS, Price/Sales）：`PS = 总市值 / 营业收入`
  - EV/EBITDA：企业价值/息税折旧摊销前利润

- **成长因子**
  - 营业收入增长率：`(本期营业收入 - 上期营业收入) / 上期营业收入`
  - 净利润增长率：`(本期净利润 - 上期净利润) / 上期净利润`
  - 每股收益增长率

- **质量因子**
  - ROE（净资产收益率）：`ROE = 净利润 / 平均净资产`
  - ROA（总资产收益率）：`ROA = 净利润 / 平均总资产`
  - 毛利率、净利率
  - 盈利质量（经营现金流/净利润）

- **偿债能力因子**
  - 资产负债率：`资产负债率 = 总负债 / 总资产`
  - 流动比率、速动比率

- **杠杆因子**
  - 权益乘数：`总资产 / 股东权益`
  - 财务杠杆率

- **效率因子**
  - 存货周转率：`营业成本 / 平均存货`
  - 应收账款周转率：`营业收入 / 平均应收账款`
  - 总资产周转率

- **红利因子**
  - 股息率：`每股分红 / 股价`
  - 分红支付率：`分红总额 / 净利润`


> 这些因子反映企业内在价值或经营状况，对中长期选股较有效。建议结合行业特性和数据可得性进行选取和加工。

## 技术/量价因子
- **动量因子**
  - N日收益率（动量）：`(收盘价_t - 收盘价_{t-N}) / 收盘价_{t-N}`，如5日、20日动量
  - 过去N日涨跌天数比：`N日内上涨天数 / N`
  - 过去N日新高/新低突破

- **反转因子**
  - 过去N日收益率反向：`-1 * N日收益率`
  - 超跌反弹信号：如RSI<20或KDJ低位金叉

- **成交量与换手率**
  - N日均量比：`近N日平均成交量 / 近M日平均成交量`
  - 换手率：`成交量 / 流通股本`
  - 量比：`当日成交量 / 过去5日均量`

- **波动率因子**
  - 历史波动率：`Std(收益率, N)`
  - ATR（平均真实波幅）：`Mean(Max(High-Low, abs(High-前收), abs(Low-前收)), N)`
  - 收益率绝对值均值：`Mean(abs(收益率), N)`

- **流动性因子**
  - 日均成交额：`Mean(成交额, N)`
  - 买卖价差均值：`Mean(买一价-卖一价, N)`
  - 挂单深度/盘口厚度

- **资金流因子**
  - 大单净买额：`大单买入额 - 大单卖出额`
  - 主力资金净流入：`主力买入额 - 主力卖出额`
  - 主力资金占比：`主力净流入 / 总成交额`

- **筹码分布因子**
  - 持仓集中度：`前十大股东持股占比`
  - 流通股东户数变化率
  - 股东户均持股变化

- **其他常用技术指标**
  - RSI、KDJ、MACD、布林带（Bollinger Bands）、均线乖离率、OBV等

> 这些因子主要基于市场交易数据，反映价格、成交量、资金等短期变化特征，适合捕捉市场情绪和短期趋势。实际应用时建议多因子组合、回测筛选有效性。

# 已有因子库
## Alpha158

Alpha158是Qlib中的一个经典因子集，包含158个技术指标因子，主要分为四大类：K线形态因子(kbar)、价格因子(price)、成交量因子(volume)和滚动统计因子(rolling)。

## 因子分类详解

### 1. K线形态因子 (kbar) - 9个因子

这些因子基于K线的开高低收价格，用于捕捉当日价格形态特征：

| 因子名称 | 计算公式 | 含义说明 |
|---------|---------|---------|
| KMID | `($close-$open)/$open` | 收盘价相对开盘价的涨跌幅 |
| KLEN | `($high-$low)/$open` | 当日价格波动幅度相对开盘价的比例 |
| KMID2 | `($close-$open)/($high-$low+1e-12)` | 实体长度占整根K线长度的比例 |
| KUP | `($high-Greater($open, $close))/$open` | 上影线长度相对开盘价的比例 |
| KUP2 | `($high-Greater($open, $close))/($high-$low+1e-12)` | 上影线占整根K线长度的比例 |
| KLOW | `(Less($open, $close)-$low)/$open` | 下影线长度相对开盘价的比例 |
| KLOW2 | `(Less($open, $close)-$low)/($high-$low+1e-12)` | 下影线占整根K线长度的比例 |
| KSFT | `(2*$close-$high-$low)/$open` | 收盘价相对当日中点价格的偏移 |
| KSFT2 | `(2*$close-$high-$low)/($high-$low+1e-12)` | 收盘价在当日价格区间中的相对位置 |

### 2. 价格因子 (price)

基于历史价格数据，默认包含当日(window=0)的以下价格字段，每个字段都除以当日收盘价进行标准化：

| 因子名称 | 计算公式 | 含义说明 |
|---------|---------|---------|
| OPEN0 | `$open/$close` | 开盘价相对收盘价的比例 |
| HIGH0 | `$high/$close` | 最高价相对收盘价的比例 |
| LOW0 | `$low/$close` | 最低价相对收盘价的比例 |
| VWAP0 | `$vwap/$close` | 成交量加权平均价相对收盘价的比例 |

*注：如果配置了多个窗口期，会生成相应天数前的价格因子，如OPEN1, OPEN2等*

### 3. 成交量因子 (volume)

基于历史成交量数据，进行标准化处理：

| 因子名称 | 计算公式 | 含义说明 |
|---------|---------|---------|
| VOLUME0 | `$volume/($volume+1e-12)` | 当日成交量（标准化为1） |

*注：如果配置了多个窗口期，会生成相应天数前的成交量因子*

### 4. 滚动统计因子 (rolling)

这是Alpha158中最丰富的因子类别，基于不同的滚动窗口期（默认：5, 10, 20, 30, 60天）计算各种技术指标：

#### 4.1 价格趋势类因子

| 因子类型 | 因子名称示例 | 计算公式 | 含义说明 |
|---------|-------------|---------|---------|
| ROC | ROC5, ROC10, ... | `Ref($close, d)/$close` | 价格变化率，d天前价格相对当前价格 |
| MA | MA5, MA10, ... | `Mean($close, d)/$close` | 简单移动平均线，d天平均价格相对当前价格 |
| STD | STD5, STD10, ... | `Std($close, d)/$close` | 价格标准差，衡量d天内价格波动性 |
| BETA | BETA5, BETA10, ... | `Slope($close, d)/$close` | 价格变化斜率，衡量d天内价格趋势强度 |

#### 4.2 回归分析类因子

| 因子类型 | 因子名称示例 | 计算公式 | 含义说明 |
|---------|-------------|---------|---------|
| RSQR | RSQR5, RSQR10, ... | `Rsquare($close, d)` | 线性回归R平方值，衡量价格趋势的线性程度 |
| RESI | RESI5, RESI10, ... | `Resi($close, d)/$close` | 线性回归残差，衡量价格偏离趋势线的程度 |

#### 4.3 极值统计类因子

| 因子类型 | 因子名称示例 | 计算公式 | 含义说明 |
|---------|-------------|---------|---------|
| MAX | MAX5, MAX10, ... | `Max($high, d)/$close` | d天内最高价相对当前收盘价 |
| MIN | MIN5, MIN10, ... | `Min($low, d)/$close` | d天内最低价相对当前收盘价 |
| QTLU | QTLU5, QTLU10, ... | `Quantile($close, d, 0.8)/$close` | d天内价格80%分位数 |
| QTLD | QTLD5, QTLD10, ... | `Quantile($close, d, 0.2)/$close` | d天内价格20%分位数 |

#### 4.4 排序统计类因子

| 因子类型 | 因子名称示例 | 计算公式 | 含义说明 |
|---------|-------------|---------|---------|
| RANK | RANK5, RANK10, ... | `Rank($close, d)` | 当前价格在d天内的排序百分位 |
| RSV | RSV5, RSV10, ... | `($close-Min($low, d))/(Max($high, d)-Min($low, d)+1e-12)` | 随机指标，当前价格在d天价格区间中的位置 |

#### 4.5 时间序列位置类因子

| 因子类型 | 因子名称示例 | 计算公式 | 含义说明 |
|---------|-------------|---------|---------|
| IMAX | IMAX5, IMAX10, ... | `IdxMax($high, d)/d` | 最高价出现位置，Aroon指标的组成部分 |
| IMIN | IMIN5, IMIN10, ... | `IdxMin($low, d)/d` | 最低价出现位置，Aroon指标的组成部分 |
| IMXD | IMXD5, IMXD10, ... | `(IdxMax($high, d)-IdxMin($low, d))/d` | 最高价与最低价出现时间差，衡量动量方向 |

#### 4.6 相关性类因子

| 因子类型 | 因子名称示例 | 计算公式 | 含义说明 |
|---------|-------------|---------|---------|
| CORR | CORR5, CORR10, ... | `Corr($close, Log($volume+1), d)` | 价格与成交量的相关性 |
| CORD | CORD5, CORD10, ... | `Corr($close/Ref($close,1), Log($volume/Ref($volume, 1)+1), d)` | 价格变化率与成交量变化率的相关性 |

#### 4.7 涨跌统计类因子

| 因子类型 | 因子名称示例 | 计算公式 | 含义说明 |
|---------|-------------|---------|---------|
| CNTP | CNTP5, CNTP10, ... | `Mean($close>Ref($close, 1), d)` | d天内上涨天数占比 |
| CNTN | CNTN5, CNTN10, ... | `Mean($close<Ref($close, 1), d)` | d天内下跌天数占比 |
| CNTD | CNTD5, CNTD10, ... | `Mean($close>Ref($close, 1), d)-Mean($close<Ref($close, 1), d)` | 上涨天数与下跌天数的差值 |

#### 4.8 累积收益类因子 (类RSI指标)

| 因子类型 | 因子名称示例 | 计算公式 | 含义说明 |
|---------|-------------|---------|---------|
| SUMP | SUMP5, SUMP10, ... | `Sum(Greater($close-Ref($close, 1), 0), d)/(Sum(Abs($close-Ref($close, 1)), d)+1e-12)` | 累积涨幅占总变化幅度的比例 |
| SUMN | SUMN5, SUMN10, ... | `Sum(Greater(Ref($close, 1)-$close, 0), d)/(Sum(Abs($close-Ref($close, 1)), d)+1e-12)` | 累积跌幅占总变化幅度的比例 |
| SUMD | SUMD5, SUMD10, ... | `(Sum(Greater($close-Ref($close, 1), 0), d)-Sum(Greater(Ref($close, 1)-$close, 0), d))/(Sum(Abs($close-Ref($close, 1)), d)+1e-12)` | 累积涨跌幅度差值比例 |

#### 4.9 成交量相关因子

| 因子类型 | 因子名称示例 | 计算公式 | 含义说明 |
|---------|-------------|---------|---------|
| VMA | VMA5, VMA10, ... | `Mean($volume, d)/($volume+1e-12)` | 成交量移动平均 |
| VSTD | VSTD5, VSTD10, ... | `Std($volume, d)/($volume+1e-12)` | 成交量标准差 |
| WVMA | WVMA5, WVMA10, ... | `Std(Abs($close/Ref($close, 1)-1)*$volume, d)/(Mean(Abs($close/Ref($close, 1)-1)*$volume, d)+1e-12)` | 成交量加权价格变化波动率 |

#### 4.10 成交量累积类因子

| 因子类型 | 因子名称示例 | 计算公式 | 含义说明 |
|---------|-------------|---------|---------|
| VSUMP | VSUMP5, VSUMP10, ... | `Sum(Greater($volume-Ref($volume, 1), 0), d)/(Sum(Abs($volume-Ref($volume, 1)), d)+1e-12)` | 成交量增长累积占总变化的比例 |
| VSUMN | VSUMN5, VSUMN10, ... | `Sum(Greater(Ref($volume, 1)-$volume, 0), d)/(Sum(Abs($volume-Ref($volume, 1)), d)+1e-12)` | 成交量减少累积占总变化的比例 |
| VSUMD | VSUMD5, VSUMD10, ... | `(Sum(Greater($volume-Ref($volume, 1), 0), d)-Sum(Greater(Ref($volume, 1)-$volume, 0), d))/(Sum(Abs($volume-Ref($volume, 1)), d)+1e-12)` | 成交量增减差值比例 |

## 配置说明

Alpha158的因子配置结构如下：

```python
config = {
    'kbar': {},  # 是否使用K线形态因子
    'price': {   # 是否使用原始价格因子
        'windows': [0, 1, 2, 3, 4],  # 使用n天前的价格
        'feature': ['OPEN', 'HIGH', 'LOW', 'CLOSE', 'VWAP']  # 使用哪些价格字段
    },
    'volume': {  # 是否使用原始成交量因子
        'windows': [0, 1, 2, 3, 4],  # 使用n天前的成交量
    },
    'rolling': { # 是否使用滚动统计因子
        'windows': [5, 10, 20, 30, 60],  # 滚动窗口大小
        'include': ['ROC', 'MA', 'STD'],  # 包含的滚动算子
        'exclude': ['RANK'],  # 排除的滚动算子
    }
}
```

## 因子设计理念

1. **标准化处理**: 所有价格类因子都除以当前收盘价进行标准化，消除价格量纲影响
2. **多时间维度**: 通过不同的滚动窗口期捕捉短期、中期、长期的市场特征
3. **技术指标覆盖**: 涵盖了经典的技术分析指标，如移动平均、RSI类指标、Aroon指标等
4. **量价结合**: 同时考虑价格和成交量信息，以及两者之间的相关性
5. **形态识别**: K线形态因子帮助识别当日的价格行为模式

## 总计因子数量

- K线形态因子: 9个
- 价格因子: 4个（默认配置）
- 成交量因子: 1个（默认配置）
- 滚动统计因子: ~144个（基于默认的5个窗口期和29类因子）

**总计约158个因子**，这也是Alpha158名称的由来。
